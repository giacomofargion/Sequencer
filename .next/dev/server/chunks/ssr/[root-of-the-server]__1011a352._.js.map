{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Projects24/Code/Sequencer/types/sequencer.ts"],"sourcesContent":["// Core data model for the step sequencer lives here so UI and audio can share it.\n\nexport type InstrumentId = \"kick\" | \"snare\" | \"hihat\" | \"tom\" | \"synth\";\n\nexport const INSTRUMENTS: InstrumentId[] = [\n  \"kick\",\n  \"snare\",\n  \"hihat\",\n  \"tom\",\n  \"synth\",\n];\n\nexport type StepState = {\n  active: boolean;\n  // In the future we can add per-step velocity, probability, etc.\n};\n\nexport type Pattern = StepState[][];\n\nexport type TransportState = {\n  isPlaying: boolean;\n  tempo: number;\n  startStep: number;\n  endStep: number;\n  currentStep: number;\n};\n\nexport type InstrumentParams = {\n  pitch: number;\n  decay: number;\n  timbre: number;\n};\n\nexport type InstrumentParamMap = Record<InstrumentId, InstrumentParams>;\n\nexport type SequencerState = {\n  pattern: Pattern;\n  transport: TransportState;\n  instruments: InstrumentParamMap;\n};\n\nexport const NUM_STEPS = 16;\n\nexport function createEmptyPattern(steps: number = NUM_STEPS): Pattern {\n  return INSTRUMENTS.map(() =>\n    Array.from({ length: steps }, () => ({ active: false })),\n  );\n}\n\nexport function createDefaultTransport(): TransportState {\n  return {\n    isPlaying: false,\n    tempo: 100,\n    startStep: 0,\n    endStep: NUM_STEPS - 1,\n    currentStep: 0,\n  };\n}\n\nexport function createDefaultInstrumentParams(): InstrumentParamMap {\n  return {\n    kick: { pitch: -12, decay: 0.6, timbre: 0.5 },\n    snare: { pitch: 0, decay: 0.4, timbre: 0.7 },\n    hihat: { pitch: 12, decay: 0.2, timbre: 0.8 },\n    tom: { pitch: -5, decay: 0.5, timbre: 0.6 },\n    synth: { pitch: 0, decay: 0.8, timbre: 0.5 },\n  };\n}\n\n// Collaboration types for real-time room sync\nexport type RoomId = string; // Short, URL-friendly code (e.g., \"abc123\")\n\nexport type Participant = {\n  id: string; // Client-generated UUID\n  name?: string; // Optional display name\n  joinedAt: number; // Timestamp\n};\n\nexport type RoomState = {\n  id: RoomId;\n  pattern: Pattern;\n  transport: TransportState;\n  instruments: InstrumentParamMap;\n  participants: Participant[];\n  createdAt: number;\n  lastActivity: number;\n};\n\nexport type SyncMessage =\n  | { type: \"step_toggle\"; row: number; col: number; userId: string; timestamp: number }\n  | { type: \"transport_play\"; userId: string; timestamp: number }\n  | { type: \"transport_pause\"; userId: string; timestamp: number }\n  | { type: \"tempo_change\"; tempo: number; userId: string; timestamp: number }\n  | { type: \"range_change\"; startStep: number; endStep: number; userId: string; timestamp: number }\n  | {\n      type: \"instrument_param\";\n      id: InstrumentId;\n      field: \"pitch\" | \"decay\" | \"timbre\";\n      value: number;\n      userId: string;\n      timestamp: number;\n    }\n  | { type: \"participant_join\"; participant: Participant }\n  | { type: \"participant_leave\"; participantId: string }\n  | { type: \"full_sync\"; state: RoomState }; // Initial sync on join\n\n// Generate a random room ID (6 alphanumeric characters)\nexport function generateRoomId(): RoomId {\n  const chars = \"abcdefghijklmnopqrstuvwxyz0123456789\";\n  let result = \"\";\n  for (let i = 0; i < 6; i++) {\n    result += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return result;\n}\n"],"names":[],"mappings":"AAAA,kFAAkF;;;;;;;;;;;;;;;AAI3E,MAAM,cAA8B;IACzC;IACA;IACA;IACA;IACA;CACD;AA+BM,MAAM,YAAY;AAElB,SAAS,mBAAmB,QAAgB,SAAS;IAC1D,OAAO,YAAY,GAAG,CAAC,IACrB,MAAM,IAAI,CAAC;YAAE,QAAQ;QAAM,GAAG,IAAM,CAAC;gBAAE,QAAQ;YAAM,CAAC;AAE1D;AAEO,SAAS;IACd,OAAO;QACL,WAAW;QACX,OAAO;QACP,WAAW;QACX,SAAS,YAAY;QACrB,aAAa;IACf;AACF;AAEO,SAAS;IACd,OAAO;QACL,MAAM;YAAE,OAAO,CAAC;YAAI,OAAO;YAAK,QAAQ;QAAI;QAC5C,OAAO;YAAE,OAAO;YAAG,OAAO;YAAK,QAAQ;QAAI;QAC3C,OAAO;YAAE,OAAO;YAAI,OAAO;YAAK,QAAQ;QAAI;QAC5C,KAAK;YAAE,OAAO,CAAC;YAAG,OAAO;YAAK,QAAQ;QAAI;QAC1C,OAAO;YAAE,OAAO;YAAG,OAAO;YAAK,QAAQ;QAAI;IAC7C;AACF;AAwCO,SAAS;IACd,MAAM,QAAQ;IACd,IAAI,SAAS;IACb,IAAK,IAAI,IAAI,GAAG,IAAI,GAAG,IAAK;QAC1B,UAAU,MAAM,MAAM,CAAC,KAAK,KAAK,CAAC,KAAK,MAAM,KAAK,MAAM,MAAM;IAChE;IACA,OAAO;AACT"}},
    {"offset": {"line": 90, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Projects24/Code/Sequencer/app/hooks/useToneEngine.ts"],"sourcesContent":["// Audio engine hook that wraps Tone.js.\n// Keeps Tone-specific details here so UI stays simple and type-safe.\n\nimport { useEffect, useRef, useState } from \"react\";\nimport type * as ToneType from \"tone\";\nimport type {\n  InstrumentId,\n  InstrumentParamMap,\n  Pattern,\n  TransportState,\n} from \"@/types/sequencer\";\n\nexport type ToneEngineApi = {\n  ready: boolean;\n  transport: TransportState;\n  setTempo: (bpm: number) => void;\n  setRange: (startStep: number, endStep: number) => void;\n  togglePlay: () => void;\n  updatePattern: (pattern: Pattern) => void;\n  updateInstrumentParams: (params: InstrumentParamMap) => void;\n};\n\nexport function useToneEngine(\n  initialTransport: TransportState,\n  initialPattern: Pattern,\n  initialParams: InstrumentParamMap,\n): ToneEngineApi {\n  const [transport, setTransport] = useState<TransportState>(initialTransport);\n  const [ready, setReady] = useState(false);\n\n  const toneRef = useRef<ToneType | null>(null);\n  const patternRef = useRef<Pattern>(initialPattern);\n  const paramsRef = useRef<InstrumentParamMap>(initialParams);\n  const synthsRef =\n    useRef<Partial<Record<InstrumentId, ToneType.ToneAudioNode>>>();\n  const loopIdRef = useRef<string | number | null>(null);\n  const currentStepRef = useRef<number>(initialTransport.startStep);\n\n  // Lazy-load Tone.js on the client and create synths + clock.\n  useEffect(() => {\n    let cancelled = false;\n\n    const setup = async () => {\n      if (typeof window === \"undefined\") return;\n      const tone = await import(\"tone\");\n      if (cancelled) return;\n\n      toneRef.current = tone;\n\n      const synths: Partial<Record<InstrumentId, ToneType.ToneAudioNode>> = {\n        kick: new tone.MembraneSynth().toDestination(),\n        snare: new tone.NoiseSynth({\n          envelope: { attack: 0.001, decay: 0.2, sustain: 0 },\n        }).toDestination(),\n        hihat: new tone.MetalSynth({\n          envelope: { attack: 0.001, decay: 0.1, release: 0.01 },\n        }).toDestination(),\n        tom: new tone.MembraneSynth({\n          pitchDecay: 0.08,\n        }).toDestination(),\n        synth: new tone.FMSynth().toDestination(),\n      };\n\n      synthsRef.current = synths;\n      tone.Transport.bpm.value = initialTransport.tempo;\n\n      const instrumentsOrder: InstrumentId[] = [\n        \"kick\",\n        \"snare\",\n        \"hihat\",\n        \"tom\",\n        \"synth\",\n      ];\n\n      loopIdRef.current = tone.Transport.scheduleRepeat((time) => {\n        const toneModule = toneRef.current;\n        if (!toneModule || !synthsRef.current) return;\n\n        const stepIndex = currentStepRef.current;\n\n        patternRef.current.forEach((row, rowIndex) => {\n          const step = row[stepIndex];\n          if (!step?.active) return;\n\n          const instrument = instrumentsOrder[rowIndex];\n          const synth = synthsRef.current?.[instrument];\n          const params = paramsRef.current[instrument];\n\n          if (!synth || !params) return;\n\n          triggerInstrument(\n            instrument,\n            synth,\n            params,\n            toneModule,\n            time as unknown as number,\n          );\n        });\n\n        setTransport((prev) => {\n          const nextIndex =\n            prev.currentStep >= prev.endStep ? prev.startStep : prev.currentStep + 1;\n          currentStepRef.current = nextIndex;\n          return { ...prev, currentStep: nextIndex };\n        });\n      }, \"16n\");\n\n      setReady(true);\n    };\n\n    void setup();\n\n    return () => {\n      cancelled = true;\n      const tone = toneRef.current;\n      if (tone && loopIdRef.current != null) {\n        tone.Transport.clear(loopIdRef.current);\n      }\n    };\n    // We intentionally run this once; pattern/params are tracked via refs.\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const ensureStarted = async () => {\n    const tone = toneRef.current;\n    if (!tone) return;\n    if (tone.context.state !== \"running\") {\n      await tone.start();\n    }\n  };\n\n  const setTempo = (bpm: number) => {\n    setTransport((prev) => ({ ...prev, tempo: bpm }));\n    const tone = toneRef.current;\n    if (tone) {\n      tone.Transport.bpm.value = bpm;\n    }\n  };\n\n  const setRange = (startStep: number, endStep: number) => {\n    setTransport((prev) => {\n      const clampedCurrent = Math.min(Math.max(prev.currentStep, startStep), endStep);\n      currentStepRef.current = clampedCurrent;\n      return {\n        ...prev,\n        startStep,\n        endStep,\n        currentStep: clampedCurrent,\n      };\n    });\n  };\n\n  const togglePlay = async () => {\n    const tone = toneRef.current;\n    if (!tone) return;\n\n    await ensureStarted();\n\n    setTransport((prev) => {\n      const nextPlaying = !prev.isPlaying;\n      if (nextPlaying) {\n        tone.Transport.start();\n      } else {\n        tone.Transport.stop();\n        currentStepRef.current = prev.startStep;\n        return { ...prev, isPlaying: nextPlaying, currentStep: prev.startStep };\n      }\n      return { ...prev, isPlaying: nextPlaying };\n    });\n  };\n\n  const updatePattern = (pattern: Pattern) => {\n    patternRef.current = pattern;\n  };\n\n  const updateInstrumentParams = (params: InstrumentParamMap) => {\n    paramsRef.current = params;\n\n    const tone = toneRef.current;\n    const synths = synthsRef.current;\n    if (!tone || !synths) return;\n\n    (Object.keys(params) as InstrumentId[]).forEach((id) => {\n      const synth = synths[id];\n      const { pitch, decay, timbre } = params[id];\n      if (!synth) return;\n\n      // Timbre now controls multiple parameters per instrument for more dramatic sound changes.\n      if (id === \"kick\" || id === \"tom\") {\n        const drum = synth as unknown as ToneType.MembraneSynth;\n        drum.envelope.decay = decay;\n        // Wider pitchDecay range (0.01 to 0.2) makes timbre much more noticeable.\n        drum.pitchDecay = 0.01 + timbre * 0.19;\n        // Also modulate octaves to add more character variation.\n        drum.octaves = 1 + timbre * 3;\n      } else if (id === \"snare\") {\n        const noise = synth as unknown as ToneType.NoiseSynth;\n        noise.envelope.decay = decay;\n        // Timbre modulates volume: low = thinner/quieter, high = punchier/louder.\n        // Range from -12dB (thin) to +12dB (punchy) makes timbre very noticeable.\n        noise.volume.value = (timbre - 0.5) * 24;\n      } else if (id === \"hihat\") {\n        const metal = synth as unknown as ToneType.MetalSynth;\n        metal.envelope.decay = decay;\n        // Much wider harmonicity range (1 to 20) for dramatic timbral shifts.\n        metal.set({ harmonicity: 1 + timbre * 19 });\n        // Also modulate resonance for more character.\n        metal.set({ resonance: 200 + timbre * 800 });\n      } else if (id === \"synth\") {\n        const fm = synth as unknown as ToneType.FMSynth;\n        fm.envelope.decay = decay;\n        // Harmonicity range expanded (0.5 to 8) for more dramatic FM timbres.\n        fm.set({ harmonicity: 0.5 + timbre * 7.5 });\n        // Modulation index is key to FM character - wide range (0.1 to 20) makes timbre very noticeable.\n        fm.set({ modulationIndex: 0.1 + timbre * 19.9 });\n        fm.detune.value = pitch * 10;\n      }\n    });\n  };\n\n  return {\n    ready,\n    transport,\n    setTempo,\n    setRange,\n    togglePlay,\n    updatePattern,\n    updateInstrumentParams,\n  };\n}\n\nfunction triggerInstrument(\n  id: InstrumentId,\n  synth: ToneType.ToneAudioNode,\n  params: InstrumentParamMap[InstrumentId],\n  tone: typeof import(\"tone\"),\n  time: number,\n) {\n  const { pitch, decay, timbre } = params;\n\n  if (id === \"kick\") {\n    (synth as ToneType.MembraneSynth).triggerAttackRelease(\n      tone.Frequency(50, \"hz\").transpose(pitch).toFrequency(),\n      decay,\n      time,\n    );\n  } else if (id === \"tom\") {\n    (synth as ToneType.MembraneSynth).triggerAttackRelease(\n      tone.Frequency(100, \"hz\").transpose(pitch).toFrequency(),\n      decay,\n      time,\n    );\n  } else if (id === \"snare\") {\n    (synth as ToneType.NoiseSynth).triggerAttackRelease(decay, time);\n  } else if (id === \"hihat\") {\n    (synth as ToneType.MetalSynth).triggerAttackRelease(decay, time);\n  } else if (id === \"synth\") {\n    (synth as ToneType.FMSynth).triggerAttackRelease(\n      tone.Frequency(\"C4\").transpose(pitch).toFrequency(),\n      decay,\n      time,\n    );\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 261, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Projects24/Code/Sequencer/lib/supabase.ts"],"sourcesContent":["// Supabase client setup for real-time collaboration.\n// In production, these should be environment variables.\n\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || \"\";\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || \"\";\n\nif (!supabaseUrl || !supabaseAnonKey) {\n  console.warn(\n    \"Supabase credentials not found. Collaboration features will not work. \" +\n      \"Set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY environment variables.\",\n  );\n}\n\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey, {\n  realtime: {\n    params: {\n      eventsPerSecond: 10,\n    },\n  },\n});\n"],"names":[],"mappings":"AAAA,qDAAqD;AACrD,wDAAwD;;;;;AAExD;;AAEA,MAAM,cAAc,gFAAwC;AAC5D,MAAM,kBAAkB,wPAA6C;AAErE;;AAOO,MAAM,WAAW,IAAA,uLAAY,EAAC,aAAa,iBAAiB;IACjE,UAAU;QACR,QAAQ;YACN,iBAAiB;QACnB;IACF;AACF"}},
    {"offset": {"line": 284, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Projects24/Code/Sequencer/app/hooks/useRoomSync.ts"],"sourcesContent":["// Real-time room synchronization hook using Supabase Realtime.\n// Manages room state, broadcasts local changes, and merges remote updates.\n\n\"use client\";\n\nimport { useEffect, useRef, useState, useCallback } from \"react\";\nimport { supabase } from \"@/lib/supabase\";\nimport type { RealtimeChannel } from \"@supabase/supabase-js\";\nimport type {\n  RoomId,\n  RoomState,\n  Pattern,\n  TransportState,\n  InstrumentParamMap,\n  InstrumentId,\n  Participant,\n  SyncMessage,\n} from \"@/types/sequencer\";\nimport {\n  createEmptyPattern,\n  createDefaultTransport,\n  createDefaultInstrumentParams,\n} from \"@/types/sequencer\";\n\ntype UseRoomSyncReturn = {\n  roomState: RoomState | null;\n  isConnected: boolean;\n  participants: Participant[];\n  isLoading: boolean;\n  error: string | null;\n  updatePattern: (pattern: Pattern) => void;\n  updateTransport: (transport: Partial<TransportState>) => void;\n  updateInstrumentParam: (\n    id: InstrumentId,\n    field: \"pitch\" | \"decay\" | \"timbre\",\n    value: number,\n  ) => void;\n  toggleStep: (row: number, col: number) => void;\n};\n\n// Generate a unique user ID for this session (stored in localStorage)\nfunction getUserId(): string {\n  const stored = typeof window !== \"undefined\" ? localStorage.getItem(\"sequencer_user_id\") : null;\n  if (stored) return stored;\n  const newId = `user_${Date.now()}_${Math.random().toString(36).substring(7)}`;\n  if (typeof window !== \"undefined\") {\n    localStorage.setItem(\"sequencer_user_id\", newId);\n  }\n  return newId;\n}\n\nexport function useRoomSync(roomId: RoomId | null): UseRoomSyncReturn {\n  const [roomState, setRoomState] = useState<RoomState | null>(null);\n  const [isConnected, setIsConnected] = useState(false);\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  const channelRef = useRef<RealtimeChannel | null>(null);\n  const userIdRef = useRef<string>(getUserId());\n  const isLocalChangeRef = useRef(false); // Flag to prevent feedback loops\n\n  // Initialize room connection\n  useEffect(() => {\n    if (!roomId) {\n      // Solo mode: no room sync\n      setRoomState(null);\n      setIsConnected(false);\n      setIsLoading(false);\n      return;\n    }\n\n    setIsLoading(true);\n    setError(null);\n\n    const channel = supabase.channel(`room:${roomId}`, {\n      config: {\n        presence: {\n          key: userIdRef.current,\n        },\n      },\n    });\n\n    // Subscribe to sync messages\n    channel\n      .on(\"broadcast\", { event: \"sync\" }, (payload) => {\n        const message = payload.payload as SyncMessage;\n\n        // Ignore our own messages (prevent feedback loops)\n        if (message.userId === userIdRef.current && isLocalChangeRef.current) {\n          isLocalChangeRef.current = false;\n          return;\n        }\n\n        handleRemoteMessage(message);\n      })\n      .on(\"presence\", { event: \"sync\" }, () => {\n        // Update participants list from presence\n        const presence = channel.presenceState();\n        const participants: Participant[] = Object.values(presence)\n          .flat()\n          .map((p) => p as Participant);\n        setRoomState((prev) =>\n          prev ? { ...prev, participants } : null,\n        );\n      })\n      .on(\"presence\", { event: \"join\" }, ({ key, newPresences }) => {\n        // New participant joined\n        const newParticipant = newPresences[0] as Participant;\n        if (newParticipant && newParticipant.id !== userIdRef.current) {\n          // Send full sync to new participant\n          if (roomState) {\n            broadcastMessage({\n              type: \"full_sync\",\n              state: roomState,\n            });\n          }\n        }\n      })\n      .subscribe((status) => {\n        setIsConnected(status === \"SUBSCRIBED\");\n        setIsLoading(false);\n        if (status === \"SUBSCRIBED\") {\n          // Join presence\n          const participant: Participant = {\n            id: userIdRef.current,\n            joinedAt: Date.now(),\n          };\n          channel.track(participant);\n\n          // Fetch or create room state\n          fetchOrCreateRoom(roomId).then((state) => {\n            if (state) {\n              setRoomState(state);\n              // Broadcast full sync to other participants\n              broadcastMessage({\n                type: \"full_sync\",\n                state,\n              });\n            }\n          });\n        }\n      });\n\n    channelRef.current = channel;\n\n    return () => {\n      channel.unsubscribe();\n      channelRef.current = null;\n    };\n  }, [roomId]);\n\n  // Fetch room from Supabase or create default\n  const fetchOrCreateRoom = async (id: RoomId): Promise<RoomState | null> => {\n    try {\n      const { data, error: fetchError } = await supabase\n        .from(\"rooms\")\n        .select(\"*\")\n        .eq(\"id\", id)\n        .single();\n\n      if (fetchError && fetchError.code !== \"PGRST116\") {\n        // PGRST116 = not found, which is fine (we'll create)\n        console.error(\"Error fetching room:\", fetchError);\n        setError(\"Failed to load room\");\n        return null;\n      }\n\n      if (data) {\n        // Room exists, return it\n        return {\n          id: data.id,\n          pattern: data.pattern,\n          transport: data.transport,\n          instruments: data.instruments,\n          participants: [],\n          createdAt: new Date(data.created_at).getTime(),\n          lastActivity: new Date(data.last_activity).getTime(),\n        };\n      }\n\n      // Room doesn't exist, create default\n      const newState: RoomState = {\n        id,\n        pattern: createEmptyPattern(),\n        transport: createDefaultTransport(),\n        instruments: createDefaultInstrumentParams(),\n        participants: [],\n        createdAt: Date.now(),\n        lastActivity: Date.now(),\n      };\n\n      // Save to Supabase\n      const { error: insertError } = await supabase.from(\"rooms\").insert({\n        id: newState.id,\n        pattern: newState.pattern,\n        transport: newState.transport,\n        instruments: newState.instruments,\n        created_at: new Date(newState.createdAt).toISOString(),\n        last_activity: new Date(newState.lastActivity).toISOString(),\n      });\n\n      if (insertError) {\n        console.error(\"Error creating room:\", insertError);\n        setError(\"Failed to create room\");\n        return null;\n      }\n\n      return newState;\n    } catch (err) {\n      console.error(\"Unexpected error in fetchOrCreateRoom:\", err);\n      setError(\"Unexpected error\");\n      return null;\n    }\n  };\n\n  // Broadcast a sync message to the room\n  const broadcastMessage = useCallback(\n    (message: SyncMessage) => {\n      const channel = channelRef.current;\n      if (!channel) return;\n\n      channel.send({\n        type: \"broadcast\",\n        event: \"sync\",\n        payload: message,\n      });\n    },\n    [],\n  );\n\n  // Handle incoming remote sync messages\n  const handleRemoteMessage = useCallback((message: SyncMessage) => {\n    setRoomState((prev) => {\n      if (!prev) return prev;\n\n      switch (message.type) {\n        case \"step_toggle\": {\n          const nextPattern = prev.pattern.map((r) => r.map((s) => ({ ...s })));\n          const step = nextPattern[message.row]?.[message.col];\n          if (step) {\n            step.active = !step.active;\n          }\n          return {\n            ...prev,\n            pattern: nextPattern,\n            lastActivity: message.timestamp,\n          };\n        }\n\n        case \"transport_play\":\n          return {\n            ...prev,\n            transport: { ...prev.transport, isPlaying: true },\n            lastActivity: message.timestamp,\n          };\n\n        case \"transport_pause\":\n          return {\n            ...prev,\n            transport: { ...prev.transport, isPlaying: false, currentStep: prev.transport.startStep },\n            lastActivity: message.timestamp,\n          };\n\n        case \"tempo_change\":\n          return {\n            ...prev,\n            transport: { ...prev.transport, tempo: message.tempo },\n            lastActivity: message.timestamp,\n          };\n\n        case \"range_change\":\n          return {\n            ...prev,\n            transport: {\n              ...prev.transport,\n              startStep: message.startStep,\n              endStep: message.endStep,\n            },\n            lastActivity: message.timestamp,\n          };\n\n        case \"instrument_param\": {\n          const nextInstruments = {\n            ...prev.instruments,\n            [message.id]: {\n              ...prev.instruments[message.id],\n              [message.field]: message.value,\n            },\n          };\n          return {\n            ...prev,\n            instruments: nextInstruments,\n            lastActivity: message.timestamp,\n          };\n        }\n\n        case \"full_sync\":\n          return message.state;\n\n        default:\n          return prev;\n      }\n    });\n  }, []);\n\n  // Update pattern (optimistic update + broadcast)\n  const updatePattern = useCallback(\n    (pattern: Pattern) => {\n      setRoomState((prev) => {\n        if (!prev) return prev;\n        return { ...prev, pattern, lastActivity: Date.now() };\n      });\n\n      if (roomId) {\n        isLocalChangeRef.current = true;\n        // Note: We broadcast individual step toggles, not full pattern\n        // This is handled by toggleStep below\n      }\n    },\n    [roomId],\n  );\n\n  // Toggle a single step (optimistic + broadcast)\n  const toggleStep = useCallback(\n    (row: number, col: number) => {\n      setRoomState((prev) => {\n        if (!prev) return prev;\n        const nextPattern = prev.pattern.map((r) => r.map((s) => ({ ...s })));\n        const step = nextPattern[row]?.[col];\n        if (step) {\n          step.active = !step.active;\n        }\n        return {\n          ...prev,\n          pattern: nextPattern,\n          lastActivity: Date.now(),\n        };\n      });\n\n      if (roomId) {\n        isLocalChangeRef.current = true;\n        broadcastMessage({\n          type: \"step_toggle\",\n          row,\n          col,\n          userId: userIdRef.current,\n          timestamp: Date.now(),\n        });\n      }\n    },\n    [roomId, broadcastMessage],\n  );\n\n  // Update transport (optimistic + broadcast)\n  const updateTransport = useCallback(\n    (transport: Partial<TransportState>) => {\n      setRoomState((prev) => {\n        if (!prev) return prev;\n        return {\n          ...prev,\n          transport: { ...prev.transport, ...transport },\n          lastActivity: Date.now(),\n        };\n      });\n\n      if (roomId) {\n        isLocalChangeRef.current = true;\n\n        if (transport.isPlaying !== undefined) {\n          broadcastMessage({\n            type: transport.isPlaying ? \"transport_play\" : \"transport_pause\",\n            userId: userIdRef.current,\n            timestamp: Date.now(),\n          });\n        }\n\n        if (transport.tempo !== undefined) {\n          broadcastMessage({\n            type: \"tempo_change\",\n            tempo: transport.tempo,\n            userId: userIdRef.current,\n            timestamp: Date.now(),\n          });\n        }\n\n        if (transport.startStep !== undefined || transport.endStep !== undefined) {\n          const currentState = roomState || {\n            transport: createDefaultTransport(),\n          } as RoomState;\n          broadcastMessage({\n            type: \"range_change\",\n            startStep: transport.startStep ?? currentState.transport.startStep,\n            endStep: transport.endStep ?? currentState.transport.endStep,\n            userId: userIdRef.current,\n            timestamp: Date.now(),\n          });\n        }\n      }\n    },\n    [roomId, broadcastMessage, roomState],\n  );\n\n  // Update instrument parameter (optimistic + broadcast)\n  const updateInstrumentParam = useCallback(\n    (id: InstrumentId, field: \"pitch\" | \"decay\" | \"timbre\", value: number) => {\n      setRoomState((prev) => {\n        if (!prev) return prev;\n        const nextInstruments = {\n          ...prev.instruments,\n          [id]: {\n            ...prev.instruments[id],\n            [field]: value,\n          },\n        };\n        return {\n          ...prev,\n          instruments: nextInstruments,\n          lastActivity: Date.now(),\n        };\n      });\n\n      if (roomId) {\n        isLocalChangeRef.current = true;\n        broadcastMessage({\n          type: \"instrument_param\",\n          id,\n          field,\n          value,\n          userId: userIdRef.current,\n          timestamp: Date.now(),\n        });\n      }\n    },\n    [roomId, broadcastMessage],\n  );\n\n  return {\n    roomState,\n    isConnected,\n    participants: roomState?.participants || [],\n    isLoading,\n    error,\n    updatePattern,\n    updateTransport,\n    updateInstrumentParam,\n    toggleStep,\n  };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 687, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Projects24/Code/Sequencer/components/TransportControls.tsx"],"sourcesContent":["import type { FC } from \"react\";\n\ntype Props = {\n  tempo: number;\n  startStep: number;\n  endStep: number;\n  maxSteps: number;\n  isPlaying: boolean;\n  onTempoChange: (bpm: number) => void;\n  onRangeChange: (start: number, end: number) => void;\n  onTogglePlay: () => void;\n};\n\nexport const TransportControls: FC<Props> = ({\n  tempo,\n  startStep,\n  endStep,\n  maxSteps,\n  isPlaying,\n  onTempoChange,\n  onRangeChange,\n  onTogglePlay,\n}) => {\n  const handleStartChange = (value: number) => {\n    const clamped = Math.max(0, Math.min(value, endStep));\n    onRangeChange(clamped, endStep);\n  };\n\n  const handleEndChange = (value: number) => {\n    const clamped = Math.min(maxSteps - 1, Math.max(value, startStep));\n    onRangeChange(startStep, clamped);\n  };\n\n  return (\n    <section className=\"flex items-center justify-between border-b border-neutral-200 pb-3 text-xs\">\n      <div className=\"flex items-center gap-3\">\n        <button\n          type=\"button\"\n          onClick={onTogglePlay}\n          className=\"flex h-8 w-8 items-center justify-center rounded-full border border-neutral-400 bg-white text-[11px] uppercase tracking-[0.18em] text-neutral-700 shadow-sm transition hover:bg-neutral-100\"\n        >\n          {isPlaying ? \"❚❚\" : \"▶\"}\n        </button>\n        <div className=\"flex items-center gap-2\">\n          <span className=\"font-mono text-[11px] uppercase tracking-[0.2em] text-neutral-500\">\n            Tempo\n          </span>\n          <input\n            type=\"range\"\n            min={60}\n            max={180}\n            value={tempo}\n            onChange={(e) => onTempoChange(Number(e.target.value))}\n            className=\"h-1 w-40 accent-emerald-600\"\n          />\n          <span className=\"w-10 text-right font-mono text-[11px] text-neutral-700\">\n            {tempo}\n          </span>\n        </div>\n      </div>\n\n      <div className=\"flex items-center gap-4\">\n        <label className=\"flex items-center gap-1\">\n          <span className=\"font-mono text-[11px] uppercase tracking-[0.18em] text-neutral-500\">\n            Start\n          </span>\n          <input\n            type=\"number\"\n            min={1}\n            max={maxSteps}\n            value={startStep + 1}\n            onChange={(e) => handleStartChange(Number(e.target.value) - 1)}\n            className=\"w-14 rounded border border-neutral-300 bg-white px-1 py-0.5 text-right font-mono text-[11px]\"\n          />\n        </label>\n        <label className=\"flex items-center gap-1\">\n          <span className=\"font-mono text-[11px] uppercase tracking-[0.18em] text-neutral-500\">\n            End\n          </span>\n          <input\n            type=\"number\"\n            min={1}\n            max={maxSteps}\n            value={endStep + 1}\n            onChange={(e) => handleEndChange(Number(e.target.value) - 1)}\n            className=\"w-14 rounded border border-neutral-300 bg-white px-1 py-0.5 text-right font-mono text-[11px]\"\n          />\n        </label>\n      </div>\n    </section>\n  );\n};\n"],"names":[],"mappings":";;;;;;AAaO,MAAM,oBAA+B,CAAC,EAC3C,KAAK,EACL,SAAS,EACT,OAAO,EACP,QAAQ,EACR,SAAS,EACT,aAAa,EACb,aAAa,EACb,YAAY,EACb;IACC,MAAM,oBAAoB,CAAC;QACzB,MAAM,UAAU,KAAK,GAAG,CAAC,GAAG,KAAK,GAAG,CAAC,OAAO;QAC5C,cAAc,SAAS;IACzB;IAEA,MAAM,kBAAkB,CAAC;QACvB,MAAM,UAAU,KAAK,GAAG,CAAC,WAAW,GAAG,KAAK,GAAG,CAAC,OAAO;QACvD,cAAc,WAAW;IAC3B;IAEA,qBACE,8OAAC;QAAQ,WAAU;;0BACjB,8OAAC;gBAAI,WAAU;;kCACb,8OAAC;wBACC,MAAK;wBACL,SAAS;wBACT,WAAU;kCAET,YAAY,OAAO;;;;;;kCAEtB,8OAAC;wBAAI,WAAU;;0CACb,8OAAC;gCAAK,WAAU;0CAAoE;;;;;;0CAGpF,8OAAC;gCACC,MAAK;gCACL,KAAK;gCACL,KAAK;gCACL,OAAO;gCACP,UAAU,CAAC,IAAM,cAAc,OAAO,EAAE,MAAM,CAAC,KAAK;gCACpD,WAAU;;;;;;0CAEZ,8OAAC;gCAAK,WAAU;0CACb;;;;;;;;;;;;;;;;;;0BAKP,8OAAC;gBAAI,WAAU;;kCACb,8OAAC;wBAAM,WAAU;;0CACf,8OAAC;gCAAK,WAAU;0CAAqE;;;;;;0CAGrF,8OAAC;gCACC,MAAK;gCACL,KAAK;gCACL,KAAK;gCACL,OAAO,YAAY;gCACnB,UAAU,CAAC,IAAM,kBAAkB,OAAO,EAAE,MAAM,CAAC,KAAK,IAAI;gCAC5D,WAAU;;;;;;;;;;;;kCAGd,8OAAC;wBAAM,WAAU;;0CACf,8OAAC;gCAAK,WAAU;0CAAqE;;;;;;0CAGrF,8OAAC;gCACC,MAAK;gCACL,KAAK;gCACL,KAAK;gCACL,OAAO,UAAU;gCACjB,UAAU,CAAC,IAAM,gBAAgB,OAAO,EAAE,MAAM,CAAC,KAAK,IAAI;gCAC1D,WAAU;;;;;;;;;;;;;;;;;;;;;;;;AAMtB"}},
    {"offset": {"line": 839, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Projects24/Code/Sequencer/components/Knob.tsx"],"sourcesContent":["import { useRef } from \"react\";\nimport type { FC } from \"react\";\n\ntype Props = {\n  label: string;\n  value: number;\n  min: number;\n  max: number;\n  step: number;\n  onChange: (value: number) => void;\n};\n\n// Simple, lightweight dial control built with SVG and pointer events.\n// We keep behaviour minimal so it stays predictable on trackpads and touch.\nexport const Knob: FC<Props> = ({\n  label,\n  value,\n  min,\n  max,\n  step,\n  onChange,\n}) => {\n  const knobRef = useRef<HTMLDivElement | null>(null);\n  const valueRef = useRef(value);\n  const activeRef = useRef(false);\n\n  valueRef.current = value;\n\n  const handlePointerDown: React.PointerEventHandler<HTMLDivElement> = (\n    event,\n  ) => {\n    event.preventDefault();\n    activeRef.current = true;\n    const element = event.currentTarget;\n    element.setPointerCapture(event.pointerId);\n\n    const handleMove = (moveEvent: PointerEvent) => {\n      if (!activeRef.current) return;\n      moveEvent.preventDefault();\n\n      const delta = -moveEvent.movementY;\n      const range = max - min;\n      const sensitivity = range / 200; // 200px drag to sweep full range.\n      const nextRaw = valueRef.current + delta * sensitivity;\n      const clamped = Math.min(max, Math.max(min, nextRaw));\n      const snapped = Math.round(clamped / step) * step;\n      valueRef.current = snapped;\n      onChange(snapped);\n    };\n\n    const handleUp = () => {\n      activeRef.current = false;\n      element.releasePointerCapture(event.pointerId);\n      window.removeEventListener(\"pointermove\", handleMove);\n      window.removeEventListener(\"pointerup\", handleUp);\n    };\n\n    window.addEventListener(\"pointermove\", handleMove);\n    window.addEventListener(\"pointerup\", handleUp);\n  };\n\n  const normalized =\n    max === min ? 0 : (value - min) / (max - min); // 0..1\n  const angle = -135 + normalized * 270; // map to -135..135\n\n  return (\n    <div className=\"flex flex-col items-center gap-1\">\n      <div\n        ref={knobRef}\n        onPointerDown={handlePointerDown}\n        className=\"relative h-9 w-9 cursor-pointer rounded-full border border-neutral-300 bg-neutral-50 shadow-sm\"\n        aria-label={label}\n      >\n        <div className=\"absolute inset-[18%] rounded-full bg-neutral-100\" />\n        <div\n          className=\"absolute left-1/2 top-1/2 h-3 w-[1px] origin-bottom bg-emerald-600\"\n          style={{\n            transform: `rotate(${angle}deg) translateY(-60%)`,\n          }}\n        />\n      </div>\n      <span className=\"text-[9px] font-mono uppercase tracking-[0.18em] text-neutral-500\">\n        {label}\n      </span>\n    </div>\n  );\n};\n"],"names":[],"mappings":";;;;;AAAA;;;AAcO,MAAM,OAAkB,CAAC,EAC9B,KAAK,EACL,KAAK,EACL,GAAG,EACH,GAAG,EACH,IAAI,EACJ,QAAQ,EACT;IACC,MAAM,UAAU,IAAA,+MAAM,EAAwB;IAC9C,MAAM,WAAW,IAAA,+MAAM,EAAC;IACxB,MAAM,YAAY,IAAA,+MAAM,EAAC;IAEzB,SAAS,OAAO,GAAG;IAEnB,MAAM,oBAA+D,CACnE;QAEA,MAAM,cAAc;QACpB,UAAU,OAAO,GAAG;QACpB,MAAM,UAAU,MAAM,aAAa;QACnC,QAAQ,iBAAiB,CAAC,MAAM,SAAS;QAEzC,MAAM,aAAa,CAAC;YAClB,IAAI,CAAC,UAAU,OAAO,EAAE;YACxB,UAAU,cAAc;YAExB,MAAM,QAAQ,CAAC,UAAU,SAAS;YAClC,MAAM,QAAQ,MAAM;YACpB,MAAM,cAAc,QAAQ,KAAK,kCAAkC;YACnE,MAAM,UAAU,SAAS,OAAO,GAAG,QAAQ;YAC3C,MAAM,UAAU,KAAK,GAAG,CAAC,KAAK,KAAK,GAAG,CAAC,KAAK;YAC5C,MAAM,UAAU,KAAK,KAAK,CAAC,UAAU,QAAQ;YAC7C,SAAS,OAAO,GAAG;YACnB,SAAS;QACX;QAEA,MAAM,WAAW;YACf,UAAU,OAAO,GAAG;YACpB,QAAQ,qBAAqB,CAAC,MAAM,SAAS;YAC7C,OAAO,mBAAmB,CAAC,eAAe;YAC1C,OAAO,mBAAmB,CAAC,aAAa;QAC1C;QAEA,OAAO,gBAAgB,CAAC,eAAe;QACvC,OAAO,gBAAgB,CAAC,aAAa;IACvC;IAEA,MAAM,aACJ,QAAQ,MAAM,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,MAAM,GAAG,GAAG,OAAO;IACxD,MAAM,QAAQ,CAAC,MAAM,aAAa,KAAK,mBAAmB;IAE1D,qBACE,8OAAC;QAAI,WAAU;;0BACb,8OAAC;gBACC,KAAK;gBACL,eAAe;gBACf,WAAU;gBACV,cAAY;;kCAEZ,8OAAC;wBAAI,WAAU;;;;;;kCACf,8OAAC;wBACC,WAAU;wBACV,OAAO;4BACL,WAAW,CAAC,OAAO,EAAE,MAAM,qBAAqB,CAAC;wBACnD;;;;;;;;;;;;0BAGJ,8OAAC;gBAAK,WAAU;0BACb;;;;;;;;;;;;AAIT"}},
    {"offset": {"line": 931, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Projects24/Code/Sequencer/components/PatternGrid.tsx"],"sourcesContent":["import type { FC } from \"react\";\nimport {\n  INSTRUMENTS,\n  type InstrumentId,\n  type InstrumentParamMap,\n  type Pattern,\n} from \"@/types/sequencer\";\nimport { Knob } from \"@/components/Knob\";\n\ntype Props = {\n  pattern: Pattern;\n  currentStep: number;\n  instrumentParams: InstrumentParamMap;\n  onToggleStep: (row: number, col: number) => void;\n  onInstrumentParamChange: (\n    id: InstrumentId,\n    field: \"pitch\" | \"decay\" | \"timbre\",\n    value: number,\n  ) => void;\n};\n\nexport const PatternGrid: FC<Props> = ({\n  pattern,\n  currentStep,\n  instrumentParams,\n  onToggleStep,\n  onInstrumentParamChange,\n}) => {\n  const steps = pattern[0] ?? [];\n\n  return (\n    <section className=\"mt-3 flex flex-col gap-2\">\n      <div className=\"font-mono text-[11px] uppercase tracking-[0.2em] text-neutral-500\">\n        Pattern\n      </div>\n      <div className=\"overflow-x-auto\">\n        <div className=\"min-w-[720px] rounded border border-neutral-300 bg-white\">\n          <div className=\"flex border-b border-neutral-200 bg-neutral-50 text-[9px] font-mono uppercase tracking-[0.18em] text-neutral-500\">\n            <div className=\"flex w-24 items-center justify-end px-2\">Row</div>\n            <div className=\"flex flex-1\">\n              {steps.map((_, col) => {\n                const isCurrent = col === currentStep;\n                return (\n                  <div\n                    key={col}\n                    className={`flex h-7 flex-1 items-center justify-center border-l border-neutral-200 ${\n                      isCurrent ? \"bg-emerald-50\" : \"\"\n                    }`}\n                  >\n                    {col + 1}\n                  </div>\n                );\n              })}\n            </div>\n            <div className=\"flex w-40 items-center justify-center border-l border-neutral-200 px-2 text-[9px]\">\n              Sound\n            </div>\n          </div>\n\n          {INSTRUMENTS.map((instrument, row) => (\n            <Row\n              key={instrument}\n              instrument={instrument}\n              rowIndex={row}\n              rowSteps={pattern[row]}\n              currentStep={currentStep}\n              params={instrumentParams[instrument]}\n              onToggleStep={onToggleStep}\n              onParamChange={onInstrumentParamChange}\n            />\n          ))}\n        </div>\n      </div>\n    </section>\n  );\n};\n\ntype RowProps = {\n  instrument: InstrumentId;\n  rowIndex: number;\n  rowSteps: Pattern[number];\n  currentStep: number;\n  params: InstrumentParamMap[InstrumentId];\n  onToggleStep: (row: number, col: number) => void;\n  onParamChange: (\n    id: InstrumentId,\n    field: \"pitch\" | \"decay\" | \"timbre\",\n    value: number,\n  ) => void;\n};\n\nconst Row: FC<RowProps> = ({\n  instrument,\n  rowIndex,\n  rowSteps,\n  currentStep,\n  params,\n  onToggleStep,\n  onParamChange,\n}) => {\n  return (\n    <div className=\"flex border-t border-neutral-200\">\n      <div className=\"flex w-24 items-center justify-end bg-neutral-100 px-2 text-[11px] capitalize text-neutral-600\">\n        {instrument}\n      </div>\n      <div className=\"flex flex-1\">\n        {rowSteps.map((step, col) => {\n          const isCurrent = col === currentStep;\n          const isActive = step.active;\n          return (\n            <button\n              key={col}\n              type=\"button\"\n              onClick={() => onToggleStep(rowIndex, col)}\n              className={`h-9 flex-1 border-l border-neutral-200 transition ${\n                isActive\n                  ? \"bg-emerald-500/10 text-emerald-700\"\n                  : \"bg-white hover:bg-neutral-50\"\n              } ${isCurrent ? \"ring-1 ring-emerald-500/70\" : \"\"}`}\n            >\n              {isActive && (\n                <span className=\"block text-xs leading-none text-emerald-600\">\n                  ×\n                </span>\n              )}\n            </button>\n          );\n        })}\n      </div>\n      <div className=\"flex w-40 items-center justify-center gap-2 border-l border-neutral-200 bg-neutral-50 px-2\">\n        <Knob\n          label=\"Pitch\"\n          min={-24}\n          max={24}\n          step={1}\n          value={params.pitch}\n          onChange={(v) => onParamChange(instrument, \"pitch\", v)}\n        />\n        <Knob\n          label=\"Decay\"\n          min={0.1}\n          max={1.5}\n          step={0.05}\n          value={params.decay}\n          onChange={(v) => onParamChange(instrument, \"decay\", v)}\n        />\n        <Knob\n          label=\"Timbre\"\n          min={0}\n          max={1}\n          step={0.05}\n          value={params.timbre}\n          onChange={(v) => onParamChange(instrument, \"timbre\", v)}\n        />\n      </div>\n    </div>\n  );\n};\n"],"names":[],"mappings":";;;;;AACA;AAMA;;;;AAcO,MAAM,cAAyB,CAAC,EACrC,OAAO,EACP,WAAW,EACX,gBAAgB,EAChB,YAAY,EACZ,uBAAuB,EACxB;IACC,MAAM,QAAQ,OAAO,CAAC,EAAE,IAAI,EAAE;IAE9B,qBACE,8OAAC;QAAQ,WAAU;;0BACjB,8OAAC;gBAAI,WAAU;0BAAoE;;;;;;0BAGnF,8OAAC;gBAAI,WAAU;0BACb,cAAA,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;4BAAI,WAAU;;8CACb,8OAAC;oCAAI,WAAU;8CAA0C;;;;;;8CACzD,8OAAC;oCAAI,WAAU;8CACZ,MAAM,GAAG,CAAC,CAAC,GAAG;wCACb,MAAM,YAAY,QAAQ;wCAC1B,qBACE,8OAAC;4CAEC,WAAW,CAAC,wEAAwE,EAClF,YAAY,kBAAkB,IAC9B;sDAED,MAAM;2CALF;;;;;oCAQX;;;;;;8CAEF,8OAAC;oCAAI,WAAU;8CAAoF;;;;;;;;;;;;wBAKpG,iIAAW,CAAC,GAAG,CAAC,CAAC,YAAY,oBAC5B,8OAAC;gCAEC,YAAY;gCACZ,UAAU;gCACV,UAAU,OAAO,CAAC,IAAI;gCACtB,aAAa;gCACb,QAAQ,gBAAgB,CAAC,WAAW;gCACpC,cAAc;gCACd,eAAe;+BAPV;;;;;;;;;;;;;;;;;;;;;;AAcnB;AAgBA,MAAM,MAAoB,CAAC,EACzB,UAAU,EACV,QAAQ,EACR,QAAQ,EACR,WAAW,EACX,MAAM,EACN,YAAY,EACZ,aAAa,EACd;IACC,qBACE,8OAAC;QAAI,WAAU;;0BACb,8OAAC;gBAAI,WAAU;0BACZ;;;;;;0BAEH,8OAAC;gBAAI,WAAU;0BACZ,SAAS,GAAG,CAAC,CAAC,MAAM;oBACnB,MAAM,YAAY,QAAQ;oBAC1B,MAAM,WAAW,KAAK,MAAM;oBAC5B,qBACE,8OAAC;wBAEC,MAAK;wBACL,SAAS,IAAM,aAAa,UAAU;wBACtC,WAAW,CAAC,kDAAkD,EAC5D,WACI,uCACA,+BACL,CAAC,EAAE,YAAY,+BAA+B,IAAI;kCAElD,0BACC,8OAAC;4BAAK,WAAU;sCAA8C;;;;;;uBAV3D;;;;;gBAgBX;;;;;;0BAEF,8OAAC;gBAAI,WAAU;;kCACb,8OAAC,2HAAI;wBACH,OAAM;wBACN,KAAK,CAAC;wBACN,KAAK;wBACL,MAAM;wBACN,OAAO,OAAO,KAAK;wBACnB,UAAU,CAAC,IAAM,cAAc,YAAY,SAAS;;;;;;kCAEtD,8OAAC,2HAAI;wBACH,OAAM;wBACN,KAAK;wBACL,KAAK;wBACL,MAAM;wBACN,OAAO,OAAO,KAAK;wBACnB,UAAU,CAAC,IAAM,cAAc,YAAY,SAAS;;;;;;kCAEtD,8OAAC,2HAAI;wBACH,OAAM;wBACN,KAAK;wBACL,KAAK;wBACL,MAAM;wBACN,OAAO,OAAO,MAAM;wBACpB,UAAU,CAAC,IAAM,cAAc,YAAY,UAAU;;;;;;;;;;;;;;;;;;AAK/D"}},
    {"offset": {"line": 1129, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Projects24/Code/Sequencer/components/RoomControls.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState } from \"react\";\nimport type { FC } from \"react\";\nimport { generateRoomId, type RoomId } from \"@/types/sequencer\";\n\ntype Props = {\n  roomId: RoomId | null;\n  isConnected: boolean;\n  participantCount: number;\n  onRoomChange: (roomId: RoomId | null) => void;\n};\n\nexport const RoomControls: FC<Props> = ({\n  roomId,\n  isConnected,\n  participantCount,\n  onRoomChange,\n}) => {\n  const [inputValue, setInputValue] = useState(\"\");\n  const [showInput, setShowInput] = useState(false);\n\n  const handleCreateRoom = () => {\n    const newRoomId = generateRoomId();\n    onRoomChange(newRoomId);\n    setShowInput(false);\n  };\n\n  const handleJoinRoom = () => {\n    const trimmed = inputValue.trim().toLowerCase();\n    if (trimmed.length === 6) {\n      onRoomChange(trimmed);\n      setInputValue(\"\");\n      setShowInput(false);\n    }\n  };\n\n  const handleLeaveRoom = () => {\n    onRoomChange(null);\n    setShowInput(false);\n  };\n\n  return (\n    <div className=\"flex items-center gap-3 text-xs text-neutral-500\">\n      <div className=\"flex items-center gap-2\">\n        <span>Room Code:</span>\n        {roomId ? (\n          <div className=\"flex items-center gap-2\">\n            <span className=\"font-mono text-[11px] tracking-widest text-neutral-700\">\n              {roomId}\n            </span>\n            <span className=\"text-[10px] text-neutral-400\">\n              ({participantCount} {participantCount === 1 ? \"user\" : \"users\"})\n            </span>\n            <div\n              className={`h-2 w-2 rounded-full ${\n                isConnected ? \"bg-emerald-500\" : \"bg-yellow-500\"\n              }`}\n              title={isConnected ? \"Connected\" : \"Connecting...\"}\n            />\n          </div>\n        ) : (\n          <span className=\"font-mono text-[11px] tracking-widest text-neutral-400\">solo</span>\n        )}\n      </div>\n\n      <div className=\"flex items-center gap-2\">\n        {!roomId ? (\n          <>\n            <button\n              type=\"button\"\n              onClick={handleCreateRoom}\n              className=\"rounded border border-neutral-300 bg-white px-2 py-1 text-[10px] uppercase tracking-[0.1em] transition hover:bg-neutral-50\"\n            >\n              Create\n            </button>\n            <button\n              type=\"button\"\n              onClick={() => setShowInput(!showInput)}\n              className=\"rounded border border-neutral-300 bg-white px-2 py-1 text-[10px] uppercase tracking-[0.1em] transition hover:bg-neutral-50\"\n            >\n              Join\n            </button>\n          </>\n        ) : (\n          <button\n            type=\"button\"\n            onClick={handleLeaveRoom}\n            className=\"rounded border border-neutral-300 bg-white px-2 py-1 text-[10px] uppercase tracking-[0.1em] transition hover:bg-neutral-50\"\n          >\n            Leave\n          </button>\n        )}\n\n        {showInput && (\n          <div className=\"flex items-center gap-1\">\n            <input\n              type=\"text\"\n              value={inputValue}\n              onChange={(e) => setInputValue(e.target.value)}\n              onKeyDown={(e) => {\n                if (e.key === \"Enter\") handleJoinRoom();\n                if (e.key === \"Escape\") {\n                  setShowInput(false);\n                  setInputValue(\"\");\n                }\n              }}\n              placeholder=\"abc123\"\n              maxLength={6}\n              className=\"w-16 rounded border border-neutral-300 bg-white px-2 py-1 text-[11px] font-mono uppercase tracking-widest placeholder:text-neutral-300 focus:outline-none focus:ring-1 focus:ring-emerald-500\"\n              autoFocus\n            />\n            <button\n              type=\"button\"\n              onClick={handleJoinRoom}\n              className=\"rounded border border-neutral-300 bg-white px-2 py-1 text-[10px] uppercase tracking-[0.1em] transition hover:bg-neutral-50\"\n            >\n              Go\n            </button>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n"],"names":[],"mappings":";;;;;AAEA;AAEA;AAJA;;;;AAaO,MAAM,eAA0B,CAAC,EACtC,MAAM,EACN,WAAW,EACX,gBAAgB,EAChB,YAAY,EACb;IACC,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,iNAAQ,EAAC;IAC7C,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,iNAAQ,EAAC;IAE3C,MAAM,mBAAmB;QACvB,MAAM,YAAY,IAAA,oIAAc;QAChC,aAAa;QACb,aAAa;IACf;IAEA,MAAM,iBAAiB;QACrB,MAAM,UAAU,WAAW,IAAI,GAAG,WAAW;QAC7C,IAAI,QAAQ,MAAM,KAAK,GAAG;YACxB,aAAa;YACb,cAAc;YACd,aAAa;QACf;IACF;IAEA,MAAM,kBAAkB;QACtB,aAAa;QACb,aAAa;IACf;IAEA,qBACE,8OAAC;QAAI,WAAU;;0BACb,8OAAC;gBAAI,WAAU;;kCACb,8OAAC;kCAAK;;;;;;oBACL,uBACC,8OAAC;wBAAI,WAAU;;0CACb,8OAAC;gCAAK,WAAU;0CACb;;;;;;0CAEH,8OAAC;gCAAK,WAAU;;oCAA+B;oCAC3C;oCAAiB;oCAAE,qBAAqB,IAAI,SAAS;oCAAQ;;;;;;;0CAEjE,8OAAC;gCACC,WAAW,CAAC,qBAAqB,EAC/B,cAAc,mBAAmB,iBACjC;gCACF,OAAO,cAAc,cAAc;;;;;;;;;;;iFAIvC,8OAAC;wBAAK,WAAU;kCAAyD;;;;;;;;;;;;0BAI7E,8OAAC;gBAAI,WAAU;;oBACZ,CAAC,uBACA;;0CACE,8OAAC;gCACC,MAAK;gCACL,SAAS;gCACT,WAAU;0CACX;;;;;;0CAGD,8OAAC;gCACC,MAAK;gCACL,SAAS,IAAM,aAAa,CAAC;gCAC7B,WAAU;0CACX;;;;;;;qDAKH,8OAAC;wBACC,MAAK;wBACL,SAAS;wBACT,WAAU;kCACX;;;;;;oBAKF,2BACC,8OAAC;wBAAI,WAAU;;0CACb,8OAAC;gCACC,MAAK;gCACL,OAAO;gCACP,UAAU,CAAC,IAAM,cAAc,EAAE,MAAM,CAAC,KAAK;gCAC7C,WAAW,CAAC;oCACV,IAAI,EAAE,GAAG,KAAK,SAAS;oCACvB,IAAI,EAAE,GAAG,KAAK,UAAU;wCACtB,aAAa;wCACb,cAAc;oCAChB;gCACF;gCACA,aAAY;gCACZ,WAAW;gCACX,WAAU;gCACV,SAAS;;;;;;0CAEX,8OAAC;gCACC,MAAK;gCACL,SAAS;gCACT,WAAU;0CACX;;;;;;;;;;;;;;;;;;;;;;;;AAQb"}},
    {"offset": {"line": 1317, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Projects24/Code/Sequencer/app/page.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport {\n  createDefaultInstrumentParams,\n  createDefaultTransport,\n  createEmptyPattern,\n  NUM_STEPS,\n  type InstrumentId,\n  type InstrumentParamMap,\n  type Pattern,\n  type RoomId,\n} from \"@/types/sequencer\";\nimport { useToneEngine } from \"./hooks/useToneEngine\";\nimport { useRoomSync } from \"./hooks/useRoomSync\";\nimport { TransportControls } from \"@/components/TransportControls\";\nimport { PatternGrid } from \"@/components/PatternGrid\";\nimport { RoomControls } from \"@/components/RoomControls\";\n\nexport default function SequencerPage() {\n  // Room management: null = solo mode, string = room ID\n  const [roomId, setRoomId] = useState<RoomId | null>(null);\n\n  // Local state for solo mode (when roomId is null)\n  const [localPattern, setLocalPattern] = useState<Pattern>(() => createEmptyPattern());\n  const [localInstrumentParams, setLocalInstrumentParams] =\n    useState<InstrumentParamMap>(() => createDefaultInstrumentParams());\n\n  // Room sync hook (only active when roomId is set)\n  const roomSync = useRoomSync(roomId);\n\n  // Determine which state to use: room sync or local\n  const pattern = roomId && roomSync.roomState ? roomSync.roomState.pattern : localPattern;\n  const instrumentParams =\n    roomId && roomSync.roomState ? roomSync.roomState.instruments : localInstrumentParams;\n  const transport =\n    roomId && roomSync.roomState\n      ? roomSync.roomState.transport\n      : createDefaultTransport();\n\n  // Tone engine uses current pattern/params\n  const engine = useToneEngine(transport, pattern, instrumentParams);\n\n  // Sync room state changes to Tone engine\n  useEffect(() => {\n    if (roomId && roomSync.roomState) {\n      engine.updatePattern(roomSync.roomState.pattern);\n      engine.updateInstrumentParams(roomSync.roomState.instruments);\n    }\n  }, [roomId, roomSync.roomState, engine]);\n\n  // Sync transport changes from room\n  useEffect(() => {\n    if (roomId && roomSync.roomState) {\n      const roomTransport = roomSync.roomState.transport;\n      if (roomTransport.tempo !== engine.transport.tempo) {\n        engine.setTempo(roomTransport.tempo);\n      }\n      if (\n        roomTransport.startStep !== engine.transport.startStep ||\n        roomTransport.endStep !== engine.transport.endStep\n      ) {\n        engine.setRange(roomTransport.startStep, roomTransport.endStep);\n      }\n      if (roomTransport.isPlaying !== engine.transport.isPlaying) {\n        if (roomTransport.isPlaying && !engine.transport.isPlaying) {\n          engine.togglePlay();\n        } else if (!roomTransport.isPlaying && engine.transport.isPlaying) {\n          engine.togglePlay();\n        }\n      }\n    }\n  }, [roomId, roomSync.roomState, engine]);\n\n  const handleToggleStep = (row: number, col: number) => {\n    if (roomId) {\n      // Use room sync\n      roomSync.toggleStep(row, col);\n    } else {\n      // Local solo mode\n      setLocalPattern((prev) => {\n        const next = prev.map((r) => r.map((s) => ({ ...s })));\n        next[row][col].active = !next[row][col].active;\n        engine.updatePattern(next);\n        return next;\n      });\n    }\n  };\n\n  const handleInstrumentParamsChange = (\n    id: InstrumentId,\n    field: \"pitch\" | \"decay\" | \"timbre\",\n    value: number,\n  ) => {\n    if (roomId) {\n      // Use room sync\n      roomSync.updateInstrumentParam(id, field, value);\n    } else {\n      // Local solo mode\n      setLocalInstrumentParams((prev) => {\n        const next: InstrumentParamMap = {\n          ...prev,\n          [id]: {\n            ...prev[id],\n            [field]: value,\n          },\n        };\n        engine.updateInstrumentParams(next);\n        return next;\n      });\n    }\n  };\n\n  const handleTransportChange = {\n    tempo: (tempo: number) => {\n      if (roomId) {\n        roomSync.updateTransport({ tempo });\n      } else {\n        engine.setTempo(tempo);\n      }\n    },\n    range: (startStep: number, endStep: number) => {\n      if (roomId) {\n        roomSync.updateTransport({ startStep, endStep });\n      } else {\n        engine.setRange(startStep, endStep);\n      }\n    },\n    togglePlay: async () => {\n      if (roomId) {\n        const currentPlaying = engine.transport.isPlaying;\n        roomSync.updateTransport({ isPlaying: !currentPlaying });\n      } else {\n        await engine.togglePlay();\n      }\n    },\n  };;\n\n  return (\n    <main className=\"flex flex-1 flex-col gap-4\">\n      <header className=\"flex items-baseline justify-between border-b border-neutral-300 pb-4\">\n        <div>\n          <p className=\"text-xs uppercase tracking-[0.25em] text-neutral-500\">\n            Intersymmetric Works\n          </p>\n          <h1 className=\"text-sm font-medium tracking-[0.18em] text-neutral-800\">\n            Sequencer 01\n          </h1>\n        </div>\n        <RoomControls\n          roomId={roomId}\n          isConnected={roomSync.isConnected}\n          participantCount={roomSync.participants.length + (roomId ? 1 : 0)}\n          onRoomChange={setRoomId}\n        />\n      </header>\n\n      <section className=\"flex flex-1 flex-col rounded-md border border-neutral-300 bg-white p-4 shadow-sm\">\n        {roomSync.error && (\n          <div className=\"mb-4 rounded border border-red-200 bg-red-50 p-2 text-xs text-red-700\">\n            {roomSync.error}\n          </div>\n        )}\n\n        <TransportControls\n          tempo={engine.transport.tempo}\n          startStep={engine.transport.startStep}\n          endStep={engine.transport.endStep}\n          maxSteps={NUM_STEPS}\n          isPlaying={engine.transport.isPlaying}\n          onTempoChange={handleTransportChange.tempo}\n          onRangeChange={handleTransportChange.range}\n          onTogglePlay={handleTransportChange.togglePlay}\n        />\n\n        <PatternGrid\n          pattern={pattern}\n          currentStep={engine.transport.currentStep}\n          instrumentParams={instrumentParams}\n          onToggleStep={handleToggleStep}\n          onInstrumentParamChange={handleInstrumentParamsChange}\n        />\n\n        {!engine.ready && (\n          <p className=\"mt-4 text-xs text-neutral-400\">\n            Audio engine is loading in the background. You can already draw a\n            pattern; sound will start once it is ready.\n          </p>\n        )}\n\n        {roomId && roomSync.isLoading && (\n          <p className=\"mt-4 text-xs text-neutral-400\">Connecting to room...</p>\n        )}\n      </section>\n    </main>\n  );\n}\n"],"names":[],"mappings":"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"}}]
}